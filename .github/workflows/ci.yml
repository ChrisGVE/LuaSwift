name: CI

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]
  workflow_dispatch:
    # Allow manual trigger

jobs:
  test-combinations:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Combination 1: Standalone (all excluded)
          - name: "Standalone"
            numericswift: "0"
            arrayswift: "0"
            plotswift: "0"

          # Combination 2: NumericSwift only
          - name: "NumericSwift"
            numericswift: "1"
            arrayswift: "0"
            plotswift: "0"

          # Combination 3: ArraySwift only
          - name: "ArraySwift"
            numericswift: "0"
            arrayswift: "1"
            plotswift: "0"

          # Combination 4: PlotSwift only
          - name: "PlotSwift"
            numericswift: "0"
            arrayswift: "0"
            plotswift: "1"

          # Combination 5: NumericSwift + ArraySwift
          - name: "N+A"
            numericswift: "1"
            arrayswift: "1"
            plotswift: "0"

          # Combination 6: NumericSwift + PlotSwift
          - name: "N+P"
            numericswift: "1"
            arrayswift: "0"
            plotswift: "1"

          # Combination 7: ArraySwift + PlotSwift
          - name: "A+P"
            numericswift: "0"
            arrayswift: "1"
            plotswift: "1"

          # Combination 8: All three (default)
          - name: "N+A+P"
            numericswift: "1"
            arrayswift: "1"
            plotswift: "1"

    name: "Test: ${{ matrix.name }}"
    steps:
      - uses: actions/checkout@v4

      - name: Clone NumericSwift
        if: matrix.numericswift == '1'
        run: git clone --depth 1 https://github.com/ChrisGVE/NumericSwift.git ../NumericSwift

      - name: Clone ArraySwift
        if: matrix.arrayswift == '1'
        run: git clone --depth 1 https://github.com/ChrisGVE/ArraySwift.git ../ArraySwift

      - name: Clone PlotSwift
        if: matrix.plotswift == '1'
        run: git clone --depth 1 https://github.com/ChrisGVE/PlotSwift.git ../PlotSwift

      - name: Set up Swift
        uses: swift-actions/setup-swift@v2

      - name: Build with dependencies
        env:
          LUASWIFT_INCLUDE_NUMERICSWIFT: ${{ matrix.numericswift }}
          LUASWIFT_INCLUDE_ARRAYSWIFT: ${{ matrix.arrayswift }}
          LUASWIFT_INCLUDE_PLOTSWIFT: ${{ matrix.plotswift }}
        run: swift build

      - name: Run tests
        env:
          LUASWIFT_INCLUDE_NUMERICSWIFT: ${{ matrix.numericswift }}
          LUASWIFT_INCLUDE_ARRAYSWIFT: ${{ matrix.arrayswift }}
          LUASWIFT_INCLUDE_PLOTSWIFT: ${{ matrix.plotswift }}
        run: swift test

  # Test all Lua versions with full dependencies
  test-lua-versions:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        lua-version: ["51", "52", "53", "54", "55"]
        include:
          - lua-version: "51"
            name: "Lua 5.1"
          - lua-version: "52"
            name: "Lua 5.2"
          - lua-version: "53"
            name: "Lua 5.3"
          - lua-version: "54"
            name: "Lua 5.4"
          - lua-version: "55"
            name: "Lua 5.5"

    name: "Test: ${{ matrix.name }}"
    steps:
      - uses: actions/checkout@v4

      - name: Clone NumericSwift
        run: git clone --depth 1 https://github.com/ChrisGVE/NumericSwift.git ../NumericSwift

      - name: Clone ArraySwift
        run: git clone --depth 1 https://github.com/ChrisGVE/ArraySwift.git ../ArraySwift

      - name: Clone PlotSwift
        run: git clone --depth 1 https://github.com/ChrisGVE/PlotSwift.git ../PlotSwift

      - name: Set up Swift
        uses: swift-actions/setup-swift@v2

      - name: Build with Lua ${{ matrix.name }}
        env:
          LUASWIFT_LUA_VERSION: ${{ matrix.lua-version }}
          LUASWIFT_INCLUDE_NUMERICSWIFT: "1"
          LUASWIFT_INCLUDE_ARRAYSWIFT: "1"
          LUASWIFT_INCLUDE_PLOTSWIFT: "1"
        run: swift build

      - name: Run tests with Lua ${{ matrix.name }}
        env:
          LUASWIFT_LUA_VERSION: ${{ matrix.lua-version }}
          LUASWIFT_INCLUDE_NUMERICSWIFT: "1"
          LUASWIFT_INCLUDE_ARRAYSWIFT: "1"
          LUASWIFT_INCLUDE_PLOTSWIFT: "1"
        run: swift test

  # Summary job that depends on all test combinations
  all-tests:
    runs-on: ubuntu-latest
    needs: [test-combinations, test-lua-versions]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-combinations.result }}" != "success" ]; then
            echo "One or more dependency combinations failed"
            exit 1
          fi
          if [ "${{ needs.test-lua-versions.result }}" != "success" ]; then
            echo "One or more Lua version tests failed"
            exit 1
          fi
          echo "All 8 dependency combinations and 5 Lua versions passed!"
