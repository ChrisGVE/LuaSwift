name: Create Release

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    # Run if: PR merged with lua-update label, OR manual trigger
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'lua-update'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag and bump version
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # Remove 'v' prefix if present
          VERSION=${LATEST_TAG#v}

          # Split into major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Determine bump type (default to patch for auto-triggered, use input for manual)
          BUMP_TYPE="${{ github.event.inputs.version_bump || 'patch' }}"
          echo "Bump type: $BUMP_TYPE"

          # Bump version based on type
          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"

          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          # Extract the [Unreleased] section from CHANGELOG.md
          # Get content between ## [Unreleased] and the next ## [
          NOTES=$(awk '/^## \[Unreleased\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md)

          # If no unreleased notes, use PR title
          if [ -z "$NOTES" ]; then
            NOTES="Lua version update - see PR #${{ github.event.pull_request.number }} for details."
          fi

          # Save to file for multi-line handling
          echo "$NOTES" > /tmp/release_notes.md

          # Also create a summary line
          SUMMARY=$(echo "$NOTES" | head -5)
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG with version
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          DATE=$(date +%Y-%m-%d)

          # Replace [Unreleased] with the new version and date
          sed -i "s/^## \[Unreleased\]/## [Unreleased]\n\n## [$NEW_VERSION] - $DATE/" CHANGELOG.md

      - name: Commit CHANGELOG update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: release v${{ steps.version.outputs.new_version }}" || echo "No changes to commit"
          git push

      - name: Create and push tag
        run: |
          git tag ${{ steps.version.outputs.new_tag }}
          git push origin ${{ steps.version.outputs.new_tag }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: ${{ steps.version.outputs.new_tag }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
