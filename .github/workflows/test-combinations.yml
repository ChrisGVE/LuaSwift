name: Test Dependency Combinations

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]
  workflow_dispatch:
    # Allow manual trigger

jobs:
  test-combinations:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Combination 1: Standalone (all excluded)
          - name: "Standalone"
            numericswift: "0"
            arrayswift: "0"
            plotswift: "0"

          # Combination 2: NumericSwift only
          - name: "NumericSwift"
            numericswift: "1"
            arrayswift: "0"
            plotswift: "0"

          # Combination 3: ArraySwift only
          - name: "ArraySwift"
            numericswift: "0"
            arrayswift: "1"
            plotswift: "0"

          # Combination 4: PlotSwift only
          - name: "PlotSwift"
            numericswift: "0"
            arrayswift: "0"
            plotswift: "1"

          # Combination 5: NumericSwift + ArraySwift
          - name: "N+A"
            numericswift: "1"
            arrayswift: "1"
            plotswift: "0"

          # Combination 6: NumericSwift + PlotSwift
          - name: "N+P"
            numericswift: "1"
            arrayswift: "0"
            plotswift: "1"

          # Combination 7: ArraySwift + PlotSwift
          - name: "A+P"
            numericswift: "0"
            arrayswift: "1"
            plotswift: "1"

          # Combination 8: All three (default)
          - name: "N+A+P"
            numericswift: "1"
            arrayswift: "1"
            plotswift: "1"

    name: "Test: ${{ matrix.name }}"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Swift
        uses: swift-actions/setup-swift@v2

      - name: Build with dependencies
        env:
          LUASWIFT_INCLUDE_NUMERICSWIFT: ${{ matrix.numericswift }}
          LUASWIFT_INCLUDE_ARRAYSWIFT: ${{ matrix.arrayswift }}
          LUASWIFT_INCLUDE_PLOTSWIFT: ${{ matrix.plotswift }}
        run: swift build

      - name: Run tests
        env:
          LUASWIFT_INCLUDE_NUMERICSWIFT: ${{ matrix.numericswift }}
          LUASWIFT_INCLUDE_ARRAYSWIFT: ${{ matrix.arrayswift }}
          LUASWIFT_INCLUDE_PLOTSWIFT: ${{ matrix.plotswift }}
        run: swift test

  # Summary job that depends on all test combinations
  all-tests:
    runs-on: ubuntu-latest
    needs: test-combinations
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-combinations.result }}" != "success" ]; then
            echo "One or more dependency combinations failed"
            exit 1
          fi
          echo "All 8 dependency combinations passed!"
